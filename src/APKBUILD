# Contributor: Andrei Jiroh Eugenio Halili <ajhalili2006@andreijiroh.eu.org>
# Contributor: Robert Günzler <r@gnzler.io>
# Contributor: Xe <xe@tailscale.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Robert Günzler <r@gnzler.io>
pkgname=tailscale
pkgver=1.76.6
pkgrel=1
pkgdesc="The easiest, most secure way to use WireGuard and 2FA"
url="https://tailscale.com/"
license="BSD-3-Clause"
# s390x: upstream still doesn't have hardware to debug this
arch="all !s390x"
options="chmod-clean"
makedepends="
	go
	linux-headers
	"
checkdepends="
	helm
	iproute2-minimal
	openssh
	"
pkgusers="tailscale"
pkggroups="tailscale"
install="
	$pkgname.pre-install
	$pkgname.pre-upgrade
	$pkgname.post-install
	"
subpackages="
	$pkgname-doc
	$pkgname-openrc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/tailscale/tailscale/archive/v$pkgver.tar.gz
	$pkgname.confd
	$pkgname.initd
	$pkgname.logrotate
	$pkgname.modules-load
	$pkgname.doasd
	resolvconf
	test-bump-conn-max-overhead.patch
	"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

# secfixes:
#   1.66.1-r0:
#     - CVE-????-????? TS-2024-005
#   1.32.3-r0:
#     - CVE-2022-41924 TS-2022-004
#   0:
#     - CVE-2022-41925 TS-2022-005

prepare() {
	default_prepare

	# this script attempts to download a helm binary
	# use the helm we have in repo instead
	rm -v tool/helm
	ln -sv /usr/bin/helm tool/helm
}

build() {
	local tags="netcgo osusergo static_build xversion"
	local ldflags="
		-X tailscale.com/version.shortStamp=$pkgver
		-X tailscale.com/version.longStamp=$pkgver-AlpineLinux
		-X tailscale.com/version.gitCommitStamp=AlpineLinux
		"

	go build -tags "$tags" -ldflags "$ldflags" ./cmd/tailscale
	go build -tags "$tags" -ldflags "$ldflags" ./cmd/tailscaled
}

check() {
	# flaky test, on multiple archs
	local test_args="-skip TestAllEndpointsAreUpAndReturnExpectedResponse"

	# shellcheck disable=SC2046
	go run ./cmd/testwrapper \
		$(go list ./... | grep -Ev 'util/linuxfw|net/netcheck|wgengine/magicsock|tstest/(archtest|integration|jsdeps|iosdeps)|ssh/tailssh|containerboot|net/connstats|tool/gocross|derp/xdp') \
		$test_args
}

package() {
	install -m755 -D tailscale -t "$pkgdir"/usr/bin/
	install -m755 -D tailscaled -t "$pkgdir"/usr/sbin/

	install -m644 -D README.md -t "$pkgdir"/usr/share/doc/$pkgname/

	install -m755 -D "$srcdir"/tailscale.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/tailscale.confd "$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$srcdir"/tailscale.logrotate "$pkgdir"/etc/logrotate.d/$pkgname
	install -m644 -D "$srcdir"/tailscale.modules-load "$pkgdir"/usr/lib/modules-load.d/$pkgname.conf

	install -m755 -D "$srcdir"/resolvconf -t "$pkgdir"/usr/libexec/$pkgname/
	install -m640 -D "$srcdir"/$pkgname.doasd "$pkgdir"/etc/doas.d/$pkgname.conf

	install -d -m750 -o tailscale -g tailscale "$pkgdir"/var/lib/$pkgname
}

sha512sums="
00173b25685c6800fb5b914e9cb1dbfd55b9ddada2006c310d388af4c12760830281717c374113d525103ed77508d2bf8ac260c596ea5c4068c0ca6a35d58c96  tailscale-1.76.6.tar.gz
73387de31f04d2cd1b5c64fdc4306b42dccfdb84a050df7c0f625ce8a29d0f5d278c4235b92844cc673fce4930318efdd17cc2bdb577e30b4c87fd8e63914ebc  tailscale.confd
88536188976580ffff2c1f82a39ae00f06914e6d4954525788d772e13a0e128f8c43b4f7237dc5c7e1832bd3b99f9abb292749dcf7e795303fe651e8b1f5d349  tailscale.initd
4f44f59553142bff5ca0914543114e4a6e3e413a96353543551445be6fa3ddc1037492baf0e091c95fe22a63e639b58bc5040285b8b5d246dbb57b70337d5178  tailscale.logrotate
871b650ff982be061532b4c5fe4812f41e6e2c58fc69b24f8a745f9a43389da44e742a69b0467b3c3d9e2b031af0728e20f10fa4584695c4f5ac87768a1fd34e  tailscale.modules-load
2a5b939bef6fc81909e81dc48a4aeb71c9e0bbeeeb2e6ea19f5c9502d1d327435baee9e42528fb9fd4061eab6fa9ecb969416d0e1e1c7a7e4aa8c20e0593fb2b  tailscale.doasd
4493980e1fe01ab8e737ef6ca6c9b73b5a1f7d0460c737a746d37bdc134892c3cb67591fe26649cccb652517fe81db871ef27db732567af6e0df31c79e5a6fd2  resolvconf
230498ba11a5e075200aefd4aa3110a3c4b9ea6d13b2a479058affaf2eb175e1c33583f56225d3e03f468136814f55b84b7b65609ac110467193652607079b05  test-bump-conn-max-overhead.patch
"
